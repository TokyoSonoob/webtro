<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÇ‡∏ó‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</title>
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --soft:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#8b5cf6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(160deg,#0b1220 0,#0e1530 45%,#0b1220 100%);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:flex;align-items:center;justify-content:center;padding:18px}
    .app{width:min(1100px,100%);background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border:1px solid #1f2937;border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3344;background:#101826}
    .grid{display:grid;gap:12px;grid-template-columns:320px 1fr}
    .card{background:var(--soft);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    .row>*{flex:1}
    .btn{background:#1f2433;border:1px solid #263047;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)} .btn.primary{background:var(--accent);border-color:#6d28d9}
    .btn.danger{background:#2a1720;border-color:#3b1d25}
    .input{background:#0b1220;border:1px solid #1f2937;color:var(--text);padding:10px 12px;border-radius:10px}
    .code{font:600 28px/1.2 ui-monospace,Menlo,Consolas,monospace;letter-spacing:2px}
    .hint{font-size:12px;color:var(--muted)}
    .videos{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .vidwrap{position:relative;background:#000;border-radius:12px;overflow:hidden;border:1px solid #1f2937;min-height:240px}
    video{width:100%;height:100%;object-fit:cover;background:#000}
    .label{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.5);padding:4px 8px;border-radius:999px;font-size:12px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üìû ‡πÇ‡∏ó‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å</h1>
      <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status" class="pill">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></div>
    </header>

    <div class="grid">
      <section class="card">
        <h3 style="margin-top:0">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h3>
        <div class="row" style="margin-bottom:8px">
          <button id="createBtn" class="btn primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏£</button>
        </div>
        <div id="codeBox" style="display:none; margin-bottom:10px">
          <div class="hint">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
          <div class="row">
            <div id="roomCode" class="code">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</div>
            <button id="copyBtn" class="btn" style="flex:0 0 auto">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
          </div>
          <div class="hint">‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</div>
        </div>
        <hr style="border-color:#1f2937;border-width:1px 0 0; margin:12px 0" />
        <div class="hint" style="margin-bottom:6px">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™</div>
        <div class="row">
          <input id="joinCode" class="input" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" />
          <button id="joinBtn" class="btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
        <p class="hint" style="margin:10px 0 0">* ‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏Ñ‡∏ô (P2P). ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p>
      </section>

      <section class="card">
        <div class="videos">
          <div class="vidwrap"><video id="localVideo" autoplay playsinline muted></video><div class="label">‡∏â‡∏±‡∏ô</div></div>
          <div class="vidwrap"><video id="remoteVideo" autoplay playsinline></video><div class="label">‡∏Ñ‡∏π‡πà‡∏™‡∏≤‡∏¢</div></div>
        </div>
        <div class="toolbar">
          <button id="micBtn" class="btn">‡πÑ‡∏°‡∏Ñ‡πå: ‡πÄ‡∏õ‡∏¥‡∏î</button>
          <button id="camBtn" class="btn">‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î</button>
          <button id="hangBtn" class="btn danger">‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase & WebRTC -->
  <script type="module">
    // üëâüëâ ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Firebase Web Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏Ñ‡πà‡∏≤‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á Firebase Web):
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };

    // Firebase CDN (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      initializeFirestore, runTransaction,
      doc, setDoc, getDoc, collection, addDoc, onSnapshot,
      serverTimestamp, getDocs, deleteDoc, query, orderBy, where
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // UI helpers
    const $ = s => document.querySelector(s);
    const $status = $('#status'), $create = $('#createBtn'), $codeBox = $('#codeBox'), $roomCode = $('#roomCode'),
          $copy = $('#copyBtn'), $joinCode = $('#joinCode'), $join = $('#joinBtn'),
          $mic = $('#micBtn'), $cam = $('#camBtn'), $hang = $('#hangBtn'),
          localVideo = $('#localVideo'), remoteVideo = $('#remoteVideo');

    const setStatus = (t, cls='') => { $status.textContent = t; $status.className = 'pill ' + cls; };
    const spaceCode = c => c.split('').join(' ');

    // Init app
    const app = initializeApp(firebaseConfig);
    // ‡πÉ‡∏ä‡πâ long-polling ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ñ‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ö‡∏•‡πá‡∏≠‡∏Å WebChannel/HTTP2)
    const db  = initializeFirestore(app, { experimentalAutoDetectLongPolling: true, useFetchStreams: false });
    const auth = getAuth(app);

    onAuthStateChanged(auth, async (u) => {
      if (!u) await signInAnonymously(auth);
    });

    // WebRTC
    const pcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }], iceCandidatePoolSize: 10 };
    let pc = null, localStream = null, remoteStream = null;
    let role = null;          // 'caller' | 'callee'
    let roomRef = null, roomCode = '';
    let unsubRoom = null, unsubOtherCands = null;

    async function getMedia(){
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      localVideo.srcObject = localStream;
      return localStream;
    }
    function createPeer(){
      pc = new RTCPeerConnection(pcConfig);
      remoteStream = new MediaStream(); remoteVideo.srcObject = remoteStream;
      pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
      pc.onconnectionstatechange = () => {
        const s = pc.connectionState;
        if (s === 'connected') setStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'ok');
        else if (s === 'connecting') setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶', 'warn');
        else if (s === 'disconnected' || s === 'failed') setStatus('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'err');
      };
      return pc;
    }
    function sanitizeCode(code){ return (code||'').replace(/\D/g,'').slice(0,6); }

    async function allocateCodeTx(){
      // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ transaction ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
      for (let i=0;i<8;i++){
        const code = String(Math.floor(Math.random()*1e6)).padStart(6,'0');
        const ref = doc(db, 'calls', code);
        try{
          await runTransaction(db, async (t)=>{
            const snap = await t.get(ref);
            if (snap.exists()) throw new Error('taken');
            t.set(ref, { createdAt: serverTimestamp(), state:'waiting' });
          });
          return { code, ref };
        }catch(e){ /* taken ‚Üí ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà */ }
      }
      throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
    }

    async function createRoomFlow(){
      role = 'caller';
      setStatus('‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÑ‡∏°‡∏Ñ‡πå‚Ä¶', 'warn');
      await getMedia(); createPeer();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      // ‡∏à‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢ transaction
      const { code, ref } = await allocateCodeTx();
      roomCode = code; roomRef = ref;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á offer ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á room
      const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
      await setDoc(roomRef, { offer: { type: offer.type, sdp: offer.sdp } }, { merge: true });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™
      $codeBox.style.display = 'block';
      $roomCode.textContent = spaceCode(roomCode);
      setStatus('‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‚Ä¶', 'warn');

      // ‡∏™‡πà‡∏á ICE ‡πÄ‡∏£‡∏≤ ‚Üí offerCandidates
      const offerCandidates = collection(roomRef, 'offerCandidates');
      pc.onicecandidate = async (e) => { if (e.candidate) await addDoc(offerCandidates, e.candidate.toJSON()); };

      // ‡∏£‡∏≠ answer
      unsubRoom = onSnapshot(roomRef, async (snap)=>{
        const data = snap.data();
        if (!pc.currentRemoteDescription && data?.answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶', 'warn');
        }
      });

      // ‡∏ü‡∏±‡∏á answerCandidates (‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á)
      const answerCandidates = collection(roomRef, 'answerCandidates');
      unsubOtherCands = onSnapshot(answerCandidates, (snap)=>{
        snap.docChanges().forEach(c=>{
          if (c.type === 'added') {
            const cand = new RTCIceCandidate(c.doc.data());
            pc.addIceCandidate(cand).catch(()=>{});
          }
        });
      });
    }

    async function joinRoomFlow(){
      const raw = sanitizeCode($joinCode.value);
      if (raw.length !== 6) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å');

      const ref = doc(db, 'calls', raw);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ');
      const data = snap.data() || {};
      if (!data.offer) return alert('‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
      if (data.answer) return alert('‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß');

      role='callee'; roomRef=ref; roomCode=raw;

      await getMedia(); createPeer();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
      await setDoc(roomRef, { answer: { type: answer.type, sdp: answer.sdp }, joinedAt: serverTimestamp() }, { merge: true });

      // ‡∏™‡πà‡∏á ICE ‡πÄ‡∏£‡∏≤ ‚Üí answerCandidates
      const answerCandidates = collection(roomRef, 'answerCandidates');
      pc.onicecandidate = async (e) => { if (e.candidate) await addDoc(answerCandidates, e.candidate.toJSON()); };

      // ‡∏ü‡∏±‡∏á offerCandidates (‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á)
      const offerCandidates = collection(roomRef, 'offerCandidates');
      unsubOtherCands = onSnapshot(offerCandidates, (snap)=>{
        snap.docChanges().forEach(c=>{
          if (c.type === 'added') {
            const cand = new RTCIceCandidate(c.doc.data());
            pc.addIceCandidate(cand).catch(()=>{});
          }
        });
      });

      $codeBox.style.display = 'block';
      $roomCode.textContent = spaceCode(roomCode);
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶', 'warn');
      // ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ü‡∏±‡∏á room ‡∏≠‡∏µ‡∏Å (‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á answer ‡πÅ‡∏•‡πâ‡∏ß)
    }

    async function hangup(){
      setStatus('‡∏¢‡∏∏‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤', 'err');
      try{ unsubRoom?.(); unsubOtherCands?.(); }catch{}
      try{ pc?.close(); }catch{}
      try{ localStream?.getTracks().forEach(t => t.stop()); }catch{}
      localStream=null; remoteVideo.srcObject=null; localVideo.srcObject=null; pc=null;

      // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á (caller)
      if (role === 'caller' && roomRef) {
        try {
          const oc = collection(roomRef, 'offerCandidates');
          const ac = collection(roomRef, 'answerCandidates');
          const [ocs, acs] = await Promise.all([getDocs(query(oc, orderBy('__name__'))), getDocs(query(ac, orderBy('__name__')))]);
          await Promise.all([...ocs.docs, ...acs.docs].map(d => deleteDoc(d.ref)));
          await deleteDoc(roomRef);
        } catch {}
      }

      role=null; roomRef=null; roomCode=''; $codeBox.style.display='none';
      setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    }

    // UI handlers
    $create.addEventListener('click', ()=> createRoomFlow().catch(e=> alert(e.message||'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î')));
    $join.addEventListener('click', ()=> joinRoomFlow().catch(e=> alert(e.message||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')));
    $copy.addEventListener('click', async ()=>{
      if (!roomCode) return;
      try{ await navigator.clipboard.writeText(roomCode); $copy.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; setTimeout(()=> $copy.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 900);}catch{}
    });
    $mic.addEventListener('click', ()=>{
      const t = localStream?.getAudioTracks?.()[0]; if (!t) return; t.enabled=!t.enabled; $mic.textContent=`‡πÑ‡∏°‡∏Ñ‡πå: ${t.enabled?'‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}`;
    });
    $cam.addEventListener('click', ()=>{
      const t = localStream?.getVideoTracks?.()[0]; if (!t) return; t.enabled=!t.enabled; $cam.textContent=`‡∏Å‡∏•‡πâ‡∏≠‡∏á: ${t.enabled?'‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}`;
    });
    $hang.addEventListener('click', ()=> hangup());
    window.addEventListener('beforeunload', ()=>{ try{ pc?.close(); }catch{} });
  </script>
</body>
</html>
