<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÇ‡∏ó‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å (WebRTC + Firebase)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --soft:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#8b5cf6; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(160deg,#0b1220 0,#0e1530 45%,#0b1220 100%);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial,"Apple Color Emoji","Segoe UI Emoji";
      display:flex;align-items:center;justify-content:center;padding:18px}
    .app{width:min(1100px,100%);background:rgba(15,23,42,.85);backdrop-filter:blur(8px);border:1px solid #1f2937;
      border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.45);padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .status{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:320px 1fr}
    .card{background:var(--soft);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    .row > * {flex:1}
    .btn{background:#1f2433;border:1px solid #263047;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:var(--accent);border-color:#6d28d9}
    .btn.danger{background:#2a1720;border-color:#3b1d25}
    .input{background:#0b1220;border:1px solid #1f2937;color:var(--text);padding:10px 12px;border-radius:10px}
    .code{font:600 28px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;letter-spacing:2px;}
    .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2b3344;background:#101826;color:#a5b4fc}
    .hint{font-size:12px;color:var(--muted)}

    .videos{display:grid;gap:10px;grid-template-columns:1fr 1fr;align-items:stretch}
    .vidwrap{position:relative;background:#000;border-radius:12px;overflow:hidden;border:1px solid #1f2937;min-height:240px}
    video{width:100%;height:100%;object-fit:cover;background:#000}
    .label{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.5);padding:4px 8px;border-radius:999px;font-size:12px}

    .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3344;background:#101826}

    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üìû ‡πÇ‡∏ó‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å</h1>
      <div class="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="status" class="pill">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></div>
    </header>

    <div class="grid">
      <!-- Controls -->
      <section class="card">
        <h3 style="margin-top:0">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h3>
        <div class="row" style="margin-bottom:8px">
          <button id="createBtn" class="btn primary">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏£</button>
        </div>
        <div id="codeBox" style="display:none; margin-bottom:10px">
          <div class="hint">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
          <div class="row">
            <div id="roomCode" class="code">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</div>
            <button id="copyBtn" class="btn" style="flex:0 0 auto">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
          </div>
          <div class="hint">‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á</div>
        </div>
        <hr style="border-color:#1f2937;border-width:1px 0 0; margin:12px 0" />
        <div class="hint" style="margin-bottom:6px">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™</div>
        <div class="row">
          <input id="joinCode" class="input" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" />
          <button id="joinBtn" class="btn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</button>
        </div>
        <p class="hint" style="margin:10px 0 0">* ‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏Ñ‡∏ô (P2P). ‡∏´‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ</p>
      </section>

      <!-- Videos -->
      <section class="card">
        <div class="videos">
          <div class="vidwrap"><video id="localVideo" autoplay playsinline muted></video><div class="label">‡∏â‡∏±‡∏ô</div></div>
          <div class="vidwrap"><video id="remoteVideo" autoplay playsinline></video><div class="label">‡∏Ñ‡∏π‡πà‡∏™‡∏≤‡∏¢</div></div>
        </div>
        <div class="toolbar">
          <button id="micBtn" class="btn">‡πÑ‡∏°‡∏Ñ‡πå: ‡πÄ‡∏õ‡∏¥‡∏î</button>
          <button id="camBtn" class="btn">‡∏Å‡∏•‡πâ‡∏≠‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î</button>
          <button id="hangBtn" class="btn danger">‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Firebase + WebRTC logic -->
  <script type="module">
    // ‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡πá‡∏ö‡∏ù‡∏±‡πà‡∏á client)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID",
    };

    // ‡πÇ‡∏°‡∏î‡∏π‡∏• Firebase (CDN)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, serverTimestamp, getDocs, deleteDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ===== UI =====
    const $status = document.getElementById('status');
    const $create = document.getElementById('createBtn');
    const $codeBox = document.getElementById('codeBox');
    const $roomCode = document.getElementById('roomCode');
    const $copy = document.getElementById('copyBtn');
    const $joinCode = document.getElementById('joinCode');
    const $join = document.getElementById('joinBtn');
    const $mic = document.getElementById('micBtn');
    const $cam = document.getElementById('camBtn');
    const $hang = document.getElementById('hangBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    function setStatus(txt, cls=''){ $status.textContent = txt; $status.className = 'pill ' + cls; }

    // ===== Firebase =====
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== WebRTC state =====
    let pc = null;
    let localStream = null;
    let remoteStream = null;
    let roomRef = null;
    let roomCode = '';
    let unsubRoom = null, unsubOffer = null, unsubAnswer = null;

    const pcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }], iceCandidatePoolSize: 10 };

    function genCode(){ return String(Math.floor(Math.random()*1e6)).padStart(6,'0'); }
    function sanitizeCode(code){ return (code||'').replace(/\D/g,'').slice(0,6); }

    async function getMedia(){
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      localVideo.srcObject = localStream;
      return localStream;
    }

    function createPeer(){
      pc = new RTCPeerConnection(pcConfig);
      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;
      pc.ontrack = (e)=>{ e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t)); };
      pc.onconnectionstatechange = ()=>{
        if (!pc) return;
        const s = pc.connectionState;
        if (s === 'connected') setStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'ok');
        else if (s === 'connecting') setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶', 'warn');
        else if (s === 'disconnected' || s === 'failed') setStatus('‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'err');
      };
      return pc;
    }

    async function createRoomFlow(){
      setStatus('‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÑ‡∏°‡∏Ñ‡πå‚Ä¶', 'warn');
      await getMedia();
      createPeer();
      localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ room
      for (let i=0;i<5;i++){
        const code = genCode();
        const ref = doc(db, 'calls', code);
        const snap = await getDoc(ref);
        if (!snap.exists()) { roomCode = code; roomRef = ref; break; }
      }
      if (!roomRef) { alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); return; }

      await setDoc(roomRef, { createdAt: serverTimestamp(), state: 'waiting' });

      const offerCandidates = collection(roomRef, 'offerCandidates');
      const answerCandidates = collection(roomRef, 'answerCandidates');

      pc.onicecandidate = async (e)=>{ if (e.candidate) await addDoc(offerCandidates, e.candidate.toJSON()); };

      const offerDesc = await pc.createOffer();
      await pc.setLocalDescription(offerDesc);
      await setDoc(roomRef, { offer: { type: offerDesc.type, sdp: offerDesc.sdp } }, { merge: true });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™
      $codeBox.style.display = 'block';
      $roomCode.textContent = roomCode.split('').join(' ');
      setStatus('‡∏£‡∏≠‡∏Ñ‡∏π‡πà‡∏™‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‚Ä¶', 'warn');

      // ‡∏£‡∏≠‡∏ü‡∏±‡∏á answer
      unsubRoom = onSnapshot(roomRef, async (snap)=>{
        const data = snap.data();
        if (!pc.currentRemoteDescription && data?.answer) {
          const answerDesc = new RTCSessionDescription(data.answer);
          await pc.setRemoteDescription(answerDesc);
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶', 'warn');
        }
      });

      // ‡∏£‡∏±‡∏ö answerCandidates
      unsubAnswer = onSnapshot(answerCandidates, (snap)=>{
        snap.docChanges().forEach((c)=>{
          if (c.type === 'added') {
            const cand = new RTCIceCandidate(c.doc.data());
            pc.addIceCandidate(cand).catch(()=>{});
          }
        });
      });
    }

    async function joinRoomFlow(code){
      code = sanitizeCode(code);
      if (code.length !== 6) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å'); return; }
      const ref = doc(db, 'calls', code);
      const snap = await getDoc(ref);
      if (!snap.exists()) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ'); return; }
      const data = snap.data();
      if (!data.offer) { alert('‡∏´‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß'); return; }
      if (data.answer) { alert('‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); return; }

      roomRef = ref; roomCode = code;
      await getMedia();
      createPeer();
      localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));

      const offerDesc = new RTCSessionDescription(data.offer);
      await pc.setRemoteDescription(offerDesc);

      const answerDesc = await pc.createAnswer();
      await pc.setLocalDescription(answerDesc);
      await setDoc(roomRef, { answer: { type: answerDesc.type, sdp: answerDesc.sdp }, joinedAt: serverTimestamp() }, { merge: true });

      const offerCandidates = collection(roomRef, 'offerCandidates');
      const answerCandidates = collection(roomRef, 'answerCandidates');

      pc.onicecandidate = async (e)=>{ if (e.candidate) await addDoc(answerCandidates, e.candidate.toJSON()); };

      // ‡∏ü‡∏±‡∏á offerCandidates
      unsubOffer = onSnapshot(offerCandidates, (snap)=>{
        snap.docChanges().forEach((c)=>{
          if (c.type === 'added') {
            const cand = new RTCIceCandidate(c.doc.data());
            pc.addIceCandidate(cand).catch(()=>{});
          }
        });
      });
      setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶', 'warn');
      $codeBox.style.display = 'block';
      $roomCode.textContent = roomCode.split('').join(' ');
    }

    async function hangup(){
      try{
        setStatus('‡∏¢‡∏∏‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤', 'err');
        if (unsubRoom) unsubRoom(); if (unsubOffer) unsubOffer(); if (unsubAnswer) unsubAnswer();
      }catch{}
      try{
        if (pc) pc.close();
      }catch{}
      try{
        localStream?.getTracks().forEach(t=> t.stop());
        localStream = null; remoteVideo.srcObject = null; localVideo.srcObject = null;
      }catch{}

      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏•‡∏ö, ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
      if (roomRef){
        try{
          const oc = collection(roomRef, 'offerCandidates');
          const ac = collection(roomRef, 'answerCandidates');
          const [ocs, acs] = await Promise.all([
            getDocs(query(oc, orderBy('__name__'))),
            getDocs(query(ac, orderBy('__name__'))),
          ]);
          await Promise.all([...ocs.docs, ...acs.docs].map(d=> deleteDoc(d.ref)));
          await deleteDoc(roomRef);
        }catch{}
      }

      roomRef = null; roomCode = ''; pc = null;
      $codeBox.style.display = 'none';
      setStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    }

    // ===== UI handlers =====
    $create.addEventListener('click', ()=> createRoomFlow().catch(e=> alert(e.message||'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î')) );
    $join.addEventListener('click', ()=> joinRoomFlow($joinCode.value).catch(e=> alert(e.message||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) );
    $copy.addEventListener('click', async ()=>{
      if (!roomCode) return; try{ await navigator.clipboard.writeText(roomCode); $copy.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; setTimeout(()=> $copy.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 900);}catch{}
    });

    $mic.addEventListener('click', ()=>{
      const t = localStream?.getAudioTracks?.()[0]; if (!t) return; t.enabled = !t.enabled; $mic.textContent = `‡πÑ‡∏°‡∏Ñ‡πå: ${t.enabled? '‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}`;
    });
    $cam.addEventListener('click', ()=>{
      const t = localStream?.getVideoTracks?.()[0]; if (!t) return; t.enabled = !t.enabled; $cam.textContent = `‡∏Å‡∏•‡πâ‡∏≠‡∏á: ${t.enabled? '‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}`;
    });
    $hang.addEventListener('click', ()=> hangup());

    // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ‚Üí ‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°)
    window.addEventListener('beforeunload', ()=>{ try{ if (pc) pc.close(); }catch{} });
  </script>
</body>
</html>
