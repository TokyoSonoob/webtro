<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÇ‡∏ó‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Single‚ÄëFile WebRTC ‚Ä¢ No Firebase)</title>
  <style>
    :root{--bg:#0b1220;--card:#111827;--muted:#9CA3AF;--pri:#8b5cf6;--b:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    h1{color:var(--pri);margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{flex:1 1 300px;background:var(--card);border:1px solid var(--b);border-radius:14px;padding:14px}
    textarea{width:100%;min-height:140px;background:#0d1426;border:1px solid var(--b);color:#e5e7eb;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:12px}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
    .btn{background:var(--pri);color:#fff}
    .ghost{background:#1f2937;color:#e5e7eb}
    audio{width:100%}
    .bar{display:flex;gap:8px;flex-wrap:wrap}
    .small{font-size:12px}
    label.small{display:block;margin:8px 0 4px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìû ‡πÇ‡∏ó‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå/‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Firebase)</h1>
    <p class="muted">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß 100% ‚Äî ‡πÉ‡∏ä‡πâ <b>WebRTC</b> + <b>STUN</b> ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å/‡∏ß‡∏≤‡∏á (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠)</p>

    <div class="row">
      <div class="card">
        <h3>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</h3>
        <ol class="small muted">
          <li>‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</li>
          <li>‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏Å‡∏î <b>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç (Offer)</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢</li>
          <li>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á <b>‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç (Offer)</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Answer)</b> ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</li>
          <li>‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ß‡∏≤‡∏á <b>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Answer)</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <b>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</b> ‚Üí ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</li>
        </ol>
        <div class="bar" style="margin:10px 0">
          <button id="btnStart" class="btn">üéß ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç (Offer)</button>
          <button id="btnMakeAnswer" class="ghost">üì® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Answer)</button>
          <button id="btnSetAnswer" class="ghost">‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
        <p id="status" class="muted small">‡∏û‡∏£‡πâ‡∏≠‡∏°</p>
      </div>

      <div class="card">
        <h3>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å/‡∏ß‡∏≤‡∏á ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
        <label class="small">‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç (Offer)</label>
        <textarea id="offerBox" placeholder="(‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢)"></textarea>
        <div class="bar" style="margin:6px 0 12px">
          <button id="btnCopyOffer" class="ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç</button>
        </div>
        <label class="small">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Answer)</label>
        <textarea id="answerBox" placeholder="(‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)"></textarea>
        <div class="bar" style="margin-top:6px">
          <button id="btnCopyAnswer" class="ghost">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px">
      <div class="card">
        <h3>‡πÑ‡∏°‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
        <p class="small muted">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</p>
        <div class="bar">
          <button id="btnMute" class="ghost">üîá ‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</button>
          <button id="btnHang" class="ghost">‚òéÔ∏è ‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢</button>
        </div>
      </div>
      <div class="card">
        <h3>‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á</h3>
        <audio id="remoteAudio" autoplay playsinline controls></audio>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô / ‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î</h3>
      <ul class="small muted">
        <li>‡∏•‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ (4G/‡πÑ‡∏ß‡πÑ‡∏ü) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ù‡∏±‡πà‡∏á ‚Äî ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà STUN; ‡∏ö‡∏≤‡∏á NAT ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ TURN ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ</li>
        <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÅ‡∏•‡πâ‡∏ß</li>
        <li>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ó‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
      </ul>
    </div>
  </div>

  <script>
    // ====== Single-file WebRTC (Audio only) with Copy/Paste signaling ======
    let pc;               // RTCPeerConnection
    let localStream;      // MediaStream (audio only)
    let remoteStream;     // MediaStream for remote audio

    const $ = (id)=>document.getElementById(id);
    const statusEl = $('status');
    const offerBox = $('offerBox');
    const answerBox = $('answerBox');
    const remoteAudio = $('remoteAudio');
    const btnMute = $('btnMute');
    const btnHang = $('btnHang');

    const rtcConfig = { iceServers:[{ urls:'stun:stun.l.google.com:19302' }] };

    function setStatus(t){ statusEl.textContent = t; }

    function newPC(){
      if (pc) try{ pc.close(); }catch{};
      pc = new RTCPeerConnection(rtcConfig);
      pc.oniceconnectionstatechange = ()=> setStatus('ICE: '+pc.iceConnectionState);
      pc.onconnectionstatechange = ()=> setStatus('Peer: '+pc.connectionState);
      pc.ontrack = (ev)=>{
        if (!remoteStream) remoteStream = new MediaStream();
        ev.streams[0].getTracks().forEach(tr=> remoteStream.addTrack(tr));
        remoteAudio.srcObject = remoteStream;
      };
      return pc;
    }

    async function ensureMic(){
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
      return localStream;
    }

    // Wait until ICE gathering completes (non-trickle for easy copy/paste)
    function waitIceGatheringComplete(){
      return new Promise((resolve)=>{
        if (pc.iceGatheringState === 'complete') return resolve();
        const onchg = ()=>{ if (pc.iceGatheringState === 'complete'){ pc.removeEventListener('icegatheringstatechange', onchg); resolve(); } };
        pc.addEventListener('icegatheringstatechange', onchg);
      });
    }

    function encode(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(txt){ return JSON.parse(decodeURIComponent(escape(atob(txt)))); }

    // Buttons
    $('btnStart').addEventListener('click', async ()=>{
      try{
        setStatus('‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡∏Ñ‡πå‚Ä¶');
        await ensureMic();
        newPC();
        // add local audio tracks
        localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));

        setStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‚Ä¶');
        const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:false });
        await pc.setLocalDescription(offer);
        await waitIceGatheringComplete();
        offerBox.value = encode({ sdp: pc.localDescription.sdp, type: pc.localDescription.type });
        setStatus('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á');
      }catch(e){ setStatus('Error: '+e.message); console.error(e); }
    });

    $('btnCopyOffer').addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(offerBox.value||'');
      setStatus('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡πÅ‡∏•‡πâ‡∏ß');
    });

    $('btnMakeAnswer').addEventListener('click', async ()=>{
      try{
        const raw = (offerBox.value||'').trim();
        if (!raw) return setStatus('‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç (Offer) ‡∏Å‡πà‡∏≠‡∏ô');
        setStatus('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‚Ä¶');
        await ensureMic();
        newPC();
        localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));

        const remoteOffer = decode(raw);
        await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await waitIceGatheringComplete();
        answerBox.value = encode({ sdp: pc.localDescription.sdp, type: pc.localDescription.type });
        setStatus('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏¥‡∏ç');
      }catch(e){ setStatus('Error: '+e.message); console.error(e); }
    });

    $('btnCopyAnswer').addEventListener('click', async ()=>{
      await navigator.clipboard.writeText(answerBox.value||'');
      setStatus('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    });

    $('btnSetAnswer').addEventListener('click', async ()=>{
      try{
        const raw = (answerBox.value||'').trim();
        if (!raw) return setStatus('‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Answer) ‡∏Å‡πà‡∏≠‡∏ô');
        const remoteAnswer = decode(raw);
        await pc.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
        setStatus('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‚Ä¶');
      }catch(e){ setStatus('Error: '+e.message); console.error(e); }
    });

    btnMute.addEventListener('click', ()=>{
      if (!localStream) return;
      localStream.getAudioTracks().forEach(t=> t.enabled = !t.enabled);
      setStatus(localStream.getAudioTracks().every(t=>t.enabled) ? '‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏õ‡∏¥‡∏î' : '‡πÑ‡∏°‡∏Ñ‡πå‡∏õ‡∏¥‡∏î');
    });

    btnHang.addEventListener('click', ()=>{
      try { pc && pc.getSenders().forEach(s=> s.track && s.track.stop()); } catch{}
      try { pc && pc.close(); } catch{}
      pc = null; remoteStream = null; setStatus('‡∏ß‡∏≤‡∏á‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    });
  </script>
</body>
</html>
