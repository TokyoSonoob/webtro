<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÇ‡∏ó‡∏£‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (WebRTC Test)</title>
  <style>
    body { background:#0b1220; color:white; font-family:sans-serif; margin:0; padding:20px; }
    h1 { color:#8b5cf6; }
    video { width:45%; background:black; border-radius:12px; margin:5px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>üìû ‡πÇ‡∏ó‡∏£‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h1>
  <p>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>

  <div class="row">
    <div>
      <h3>‡∏â‡∏±‡∏ô</h3>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div>
      <h3>‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á</h3>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <script>
  // ==== Firebase Config (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á) ====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  async function init(){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    localVideo.srcObject = stream;

    const remoteStream = new MediaStream();
    pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
    remoteVideo.srcObject = remoteStream;

    const callDoc = db.collection('testCalls').doc('room');
    const offerCandidates = callDoc.collection('offerCandidates');
    const answerCandidates = callDoc.collection('answerCandidates');

    pc.onicecandidate = e => { if(e.candidate) offerCandidates.add(e.candidate.toJSON()); };

    const offerDesc = await pc.createOffer();
    await pc.setLocalDescription(offerDesc);
    await callDoc.set({ offer: { type: offerDesc.type, sdp: offerDesc.sdp } });

    callDoc.onSnapshot(async snap => {
      const data = snap.data();
      if(data?.answer && !pc.currentRemoteDescription){
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    answerCandidates.onSnapshot(snap => {
      snap.docChanges().forEach(ch => {
        if(ch.type === 'added') pc.addIceCandidate(new RTCIceCandidate(ch.doc.data()));
      });
    });

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á answer
    callDoc.get().then(async doc => {
      const data = doc.data();
      if(data?.offer && !data.answer){
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        await callDoc.set({ answer:{ type: ans.type, sdp: ans.sdp } }, { merge:true });
      }
    });
  }

  init();
  </script>
</body>
</html>
