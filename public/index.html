<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÇ‡∏ó‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (WebRTC)</title>
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --soft:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#8b5cf6; --ok:#10b981; --err:#ef4444 }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#0b1220;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",Arial}
    .wrap{max-width:720px;margin:0 auto;padding:20px}
    .card{background:var(--panel);border:1px solid #243045;border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 8px 0;font-size:22px}
    .muted{color:var(--muted);font-size:14px;margin-top:4px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:12px}
    input{background:var(--soft);border:1px solid #263246;border-radius:12px;color:var(--text);padding:10px 12px;font-size:16px;outline:none}
    button{background:var(--accent);color:white;border:none;border-radius:12px;padding:10px 14px;font-size:16px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #273042}
    button:disabled{opacity:.6}
    .status{margin-top:10px;font-size:14px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .controls{display:flex;gap:8px;margin-top:10px}
    .roomtag{background:#141b2c;border:1px dashed #2a3751;border-radius:10px;padding:8px 10px;margin-top:10px;font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üìû ‡πÇ‡∏ó‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á</h1>
      <div class="muted">‡∏Å‡∏î ‚Äú‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</div>

      <div class="row">
        <button id="create">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
        <input id="code" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å" maxlength="6" pattern="[0-9]{6}">
        <button id="go" class="ghost">‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
      </div>

      <div id="roomLine" class="roomtag" style="display:none"></div>

      <div class="controls">
        <button id="join" disabled>Join</button>
        <button id="leave" disabled>Leave</button>
        <button id="mute" class="ghost" disabled>‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</button>
      </div>

      <div id="stat" class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
    </div>

    <!-- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏π‡πà‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ -->
    <audio id="peer" autoplay></audio>
  </div>

  <script>
    const WS_URL = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/ws';
    const $ = (id)=>document.getElementById(id);
    const elCreate = $('create'), elGo = $('go'), elCode = $('code');
    const elJoin = $('join'), elLeave = $('leave'), elMute = $('mute');
    const elStat = $('stat'), elRoomLine = $('roomLine'), aPeer = $('peer');

    const pcCfg = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    let ws, pc, localStream, joined = false, makingOffer = false;

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏à‡∏≤‡∏Å URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    const url = new URL(location.href);
    const roomId = url.searchParams.get('room');
    if (roomId) { elCode.value = roomId; showRoom(roomId); elJoin.disabled = false; }

    elCreate.onclick = () => {
      const code = String(Math.floor(100000 + Math.random()*900000));
      location.href = `?room=${code}`; // ‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    };
    elGo.onclick = () => {
      const c = (elCode.value||'').trim();
      if (!/^[0-9]{6}$/.test(c)) return setStatus('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','err');
      location.href = `?room=${c}`;
    };

    function showRoom(code){
      elRoomLine.style.display = '';
      elRoomLine.textContent = `‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á: ${code}`;
    }

    function setStatus(msg, cls){ elStat.textContent = msg; elStat.className = 'status ' + (cls||''); }

    async function ensureMedia(){
      if (localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true },
        video: false
      });
      elMute.disabled = false;
      return localStream;
    }

    function connectWS(){
      if (ws && ws.readyState === WebSocket.OPEN) return;
      ws = new WebSocket(WS_URL);
      ws.onopen = () => setStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á','ok');
      ws.onclose = () => setStatus('‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì','err');
      ws.onerror = () => setStatus('‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤','err');
      ws.onmessage = async (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === 'room-full') {
          setStatus('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏° (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏Ñ‡∏ô)','err');
          toggle(false);
        } else if (msg.type === 'joined') {
          setStatus('‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≤‡∏¢‚Ä¶','ok');
          if (msg.peers > 0) await startCaller();
        } else if (msg.type === 'peer-join') {
          if (joined) startCaller();
        } else if (msg.type === 'offer') {
          await onOffer(msg.sdp);
        } else if (msg.type === 'answer') {
          await onAnswer(msg.sdp);
        } else if (msg.type === 'ice') {
          await pc?.addIceCandidate(msg.candidate).catch(()=>{});
        } else if (msg.type === 'peer-leave') {
          setStatus('‡∏Ñ‡∏π‡πà‡∏™‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á','');
          if (pc) { pc.close(); pc = null; aPeer.srcObject = null; }
        }
      };
    }

    function toggle(on){
      elJoin.disabled = on; elLeave.disabled = !on;
      elCreate.disabled = on; elGo.disabled = on; elCode.disabled = on;
    }

    elJoin.onclick = joinRoom;
    elLeave.onclick = leaveRoom;
    elMute.onclick = () => {
      const a = localStream?.getAudioTracks?.()[0];
      if (!a) return;
      a.enabled = !a.enabled;
      elMute.textContent = a.enabled ? '‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå';
    };

    async function joinRoom(){
      const code = (elCode.value||'').trim();
      if (!/^[0-9]{6}$/.test(code)) return setStatus('‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 6 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','err');
      connectWS();
      await ensureMedia();
      ws.addEventListener('open', function once(){
        ws.removeEventListener('open', once);
        ws.send(JSON.stringify({ type: 'join', roomId: code }));
        joined = true; toggle(true);
        showRoom(code);
      });
    }

    function leaveRoom(){
      joined = false; toggle(false);
      try { ws?.send(JSON.stringify({ type: 'leave' })); } catch {}
      if (pc) { pc.close(); pc = null; }
      aPeer.srcObject = null;
      setStatus('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß','');
    }

    async function createPC(){
      if (pc) return pc;
      pc = new RTCPeerConnection(pcCfg);
      pc.onicecandidate = (e)=>{ if (e.candidate) ws?.send(JSON.stringify({ type:'ice', candidate:e.candidate })); };
      pc.ontrack = (e)=>{ aPeer.srcObject = e.streams[0]; };
      const stream = await ensureMedia();
      for (const t of stream.getTracks()) pc.addTrack(t, stream);
      return pc;
    }

    async function startCaller(){
      await createPC();
      try {
        makingOffer = true;
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws?.send(JSON.stringify({ type:'offer', sdp: pc.localDescription }));
      } finally { makingOffer = false; }
    }

    async function onOffer(remoteSDP){
      await createPC();
      const glare = makingOffer || pc.signalingState !== 'stable';
      if (glare) {
        await Promise.all([
          pc.setLocalDescription({ type:'rollback' }).catch(()=>{}),
          pc.setRemoteDescription(remoteSDP)
        ]);
      } else {
        await pc.setRemoteDescription(remoteSDP);
      }
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws?.send(JSON.stringify({ type:'answer', sdp: pc.localDescription }));
    }

    async function onAnswer(remoteSDP){
      await pc?.setRemoteDescription(remoteSDP);
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏° ?room=xxxx ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏î Join ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (roomId) { elJoin.disabled = false; setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î Join',''); }
  </script>
</body>
</html>
