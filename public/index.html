<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Minecraft Voice Hub</title>
<style>
  body { background:#0b1220; color:#e5e7eb; font-family:sans-serif; padding:20px; }
  .card { background:#111827; padding:20px; border-radius:12px; max-width:600px; margin:auto; }
  input, button { padding:10px; margin:5px 0; border-radius:8px; border:none; }
  input { width:100%; background:#1f2937; color:#e5e7eb; }
  button { background:#8b5cf6; color:#fff; cursor:pointer; }
  button:disabled { opacity:.6; }
  .pill { display:inline-block; background:#1f2937; padding:5px 10px; border-radius:999px; margin:2px; font-size:12px; }
</style>
</head>
<body>
<div class="card">
  <h1>ðŸ”Š Minecraft Voice Hub</h1>
  <input id="code" placeholder="à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ª 6 à¸«à¸¥à¸±à¸">
  <button id="join">Join</button>
  <button id="leave" disabled>Leave</button>
  <button id="mute" disabled>Mute</button>
  <div id="status">à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­</div>
  <div id="peers"></div>
</div>
<div id="audios"></div>
<script>
const WS_URL = (location.protocol === 'https:'?'wss':'ws')+'://'+location.host+'/ws';
const ICE = [{ urls: 'stun:stun.l.google.com:19302' }];
let ws, local, myId=Math.random().toString(36).slice(2,8);
const pcs=new Map(), audios=new Map();

const codeEl=document.getElementById("code");
const join=document.getElementById("join");
const leave=document.getElementById("leave");
const mute=document.getElementById("mute");
const status=document.getElementById("status");
const peers=document.getElementById("peers");

function log(s){ status.textContent=s; }

async function ensureMic(){
  if(local) return local;
  local = await navigator.mediaDevices.getUserMedia({audio:true});
  return local;
}

function connectWS(){
  ws=new WebSocket(WS_URL);
  ws.onmessage=e=>onSignal(JSON.parse(e.data));
}

join.onclick=async()=>{
  if(!/^\d{6}$/.test(codeEl.value)) return log("à¸£à¸«à¸±à¸ªà¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡");
  await ensureMic(); connectWS();
  ws.onopen=()=>ws.send(JSON.stringify({type:"join",roomId:codeEl.value,peerId:myId}));
  join.disabled=true; leave.disabled=false; mute.disabled=false;
};

leave.onclick=()=>{
  ws?.send(JSON.stringify({type:"leave"}));
  for(const id of [...pcs.keys()]) closePC(id);
  join.disabled=false; leave.disabled=true; mute.disabled=true;
};

mute.onclick=()=>{
  const t=local?.getAudioTracks()[0]; if(!t)return;
  t.enabled=!t.enabled; mute.textContent=t.enabled?"Mute":"Unmute";
};

async function createPC(id,offer){
  if(pcs.has(id)) return pcs.get(id);
  const pc=new RTCPeerConnection({iceServers:ICE});
  pcs.set(id,pc);
  local.getTracks().forEach(t=>pc.addTrack(t,local));
  const au=document.createElement("audio"); au.autoplay=true; audios.set(id,au);
  document.getElementById("audios").appendChild(au);
  pc.ontrack=e=>{au.srcObject=e.streams[0];};
  pc.onicecandidate=e=>{if(e.candidate)ws.send(JSON.stringify({type:"ice",to:id,from:myId,candidate:e.candidate}));};
  if(offer){
    await pc.setLocalDescription(await pc.createOffer());
    ws.send(JSON.stringify({type:"offer",to:id,from:myId,sdp:pc.localDescription}));
  }
  return pc;
}
function closePC(id){
  pcs.get(id)?.close(); pcs.delete(id);
  audios.get(id)?.remove(); audios.delete(id);
  [...peers.children].forEach(el=>{if(el.dataset.id===id)el.remove();});
}

async function onSignal(m){
  if(m.type==="joined"){ log("à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¹à¸¥à¹‰à¸§"); m.peers.forEach(p=>createPC(p,true)); }
  if(m.type==="peer-join"){ createPC(m.peerId,true); const s=document.createElement("span"); s.className="pill"; s.dataset.id=m.peerId; s.textContent="peer:"+m.peerId; peers.appendChild(s); }
  if(m.type==="peer-leave"){ closePC(m.peerId); }
  if(m.type==="offer"){const pc=await createPC(m.from,false); await pc.setRemoteDescription(m.sdp); await pc.setLocalDescription(await pc.createAnswer()); ws.send(JSON.stringify({type:"answer",to:m.from,from:myId,sdp:pc.localDescription}));}
  if(m.type==="answer"){await pcs.get(m.from)?.setRemoteDescription(m.sdp);}
  if(m.type==="ice"){await pcs.get(m.from)?.addIceCandidate(m.candidate);}
}
</script>
</body>
</html>
